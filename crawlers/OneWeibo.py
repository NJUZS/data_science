import requests
import json

headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36 Edg/87.0.664.75',
            'Accept': '*/*',
            'Accept-Language': 'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2',
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest',
            'Connection': 'keep-alive',
    }

cookies = {
    'cookie':""
    #这是自己的cookie
}

url = "https://m.weibo.cn/comments/hotflow?id={}&mid={}&max_id_type=0"
url_max_id="https://m.weibo.cn/comments/hotflow?id={}&mid={}&max_id={}&max_id_type=0"

max_id=""
filename=""
def scrapy(id):
    list=[]
    try:
        requests.packages.urllib3.disable_warnings()
        response = requests.get(url.format(id, id),headers = headers,cookies=cookies)
        # response.close()


        data = json.loads(response.text)
        users = data.get('data', None)


        if users:
            max_id = users['max_id']

            users = users['data']
            time = users[0]['created_at'][:10]
            filename = 'Data/SinaNews/April/data {} comment {}.json'.format(time, id)

            for user in users:
                key_value = {}
                key_value['用户名称'] = user['user']['screen_name']
                key_value['评论'] = user['text'].split("<", 1)[0]
                key_value['点赞数'] = user['like_count']
                key_value['评论时间'] = user['created_at'][:10]
                list.append(key_value)

            for i in range(20):
                if max_id == 0:
                    break

                response = requests.get(url_max_id.format(id,id,max_id),headers = headers,cookies=cookies)
                # response.close()


                comment = response.json()
                if comment['ok']==0:
                    break

                data = json.loads(response.text)
                users = data.get('data',None)

                if users:
                    max_id = users['max_id']
                    users = users['data']
                    for user in users:
                        key_value = {}
                        key_value['用户名称'] = user['user']['screen_name']
                        key_value['评论'] = user['text'].split("<", 1)[0]
                        key_value['点赞数'] = user['like_count']
                        key_value['评论时间'] = user['created_at'][:10]
                        list.append(key_value)
            print("data collect ok")

    # except:
    #     scrapy(id)
            with open(filename, 'a', encoding='utf-8') as file_obj:
                json.dump(list, file_obj, ensure_ascii=False, indent=4)
                file_obj.write('\n')
                file_obj.close()
                print("file dump ok")

    except:
        return




if "__main__" == __name__:

    ## idApril=[
    #     4499528591824622,4499479854635836,4499322706260169,4499093839759769,
    #     4499084167900123,4499079826730667,4498963954368846,4498703685614778,
    #     4498689806145695,4498630897633482,4498609514954951,4498470527903499,
    #     4498423954841287,4498241859239348,4498228860652158,4498102448535481,
    #     4498010497603310,4497993694919087,4497978050256819,4497869840623284,
    #     4497672461350396,4497372187221653,4496626410328672,4496590007946647,
    #     4496433317291145,4496168212002351,4496062473101118,4495900372208529,
    #     4495442618407794,4495340998661688,4495182383159653,4495137348555152,
    #     4495079890320953,4494971224612301,4494959874462924,4494813787606566,
    #     4494724783758396,4494657612124361,4494617150205082,4494613890992513,
    #     4494609385915937,4494601803116682,4494347585798338,4494304502371189,
    #     4494255676065482,4494238161318339,4494088084131643,4494026998787653,
    #     4493972531664111,4493931825921279,4493929317555547,4493892105585073,
    #     4493866620855968,4493731073439059,4493537611904369,4493361916320834,
    #     4493184161952398,4493177194754629,4492942188174009,4492838861582874,
    #     4492826567931594,4492822889762454,4492820503515691,4492813687245861,
    #     4492799149377266,4492671424466580,4492586402093573,4492570812009593,
    #     4492542978340636,4492495179849356,4492435872293788,4492069655916801,
    #     4491922938405428,4491900012823164,4491893498734768,4491552267314530,
    #     4491533673587820,4491504120802631,4491357907435926,4491333509577876,
    #     4491329843435743,4491218593662958,4491229544852814,4491199497256946,
    #     4491177799957800,4491076503364463,4491057842607131,4491039727679058,
    #     4490799905582991,4490782067263971,4490732154566785,4490638714252514,
    #     4490392898967051,4490389056353604,4490344579759971,4490255656358822,
    #     4490082121334604,4490001314328833,4489986273357669,4489929369530559,
    #     4489927532170752,4489902215039722,4489669582208550,4489527878049440,
    #     4489324886125948,4489303809496295,4489007524437869,4488967943041509,
    #     4488880516341953
    # ]
    # idMay = [
    #     4510198200561326,4509889285757036,4509595613873194,4509560716822984,
    #     4509120882050956,4508778617487549,4508754143644323,4508740126327437,
    #     4508610317076551,4508393535429510,4508378606388831,4508014319641486,
    #     4507664568697210,4507529121729531,4507348485388725,4507331981734101,
    #     4507312109449265,4507164142649947,4507105349927723,4506934483755011,
    #     4506662470610396,4506024134649329,4506017839303711,4505916047496791,
    #     4505855409626484,4505598295257583,4505493605699760,4505312323438989,
    #     4505262491303493,4505232972154865,4505139077647293,4504863222271905,
    #     4504750094487226,4504600378323432,4504551472245172,4504240217841672,
    #     4504126527070417,4504022499606115,4503878236051506,4503352345931088,
    #     4503324722120670,4503318263775770,4503132095108337,4503085709935216,
    #     4503023911200387,4502959206085731,4502948380494981,4502943845965579,
    #     4502596779483386,4502416059707256,4502222870763591,4500995675174697,
    #     4500917900642482,4500767442329411,4500597556490898,4500548617687504,
    #     4500515394899548,4500492125052091,4500422831081210,4500387136269796,
    #     4500234220829374,4500051034736173,4499790115896560,4499681353356482
    # ]
    # idJune=[
    #     4499681353356482,4520698360080273,4520344905729395,4520093922525366,
    #     4520015111862198,4519994987306097,4519987958733249,4519787621324792,
    #     4519622306898144,4519460029428488,4519384309518701,4519261139911814,
    #     4519048014630671,4519030754758831,4519006088389559,4518889713452610,
    #     4518766316690845,4518723841937313,4518700524441408,4518643579505830,
    #     4518585122691668,4518533894138325,4518523525258023,4518394449499216,
    #     4518358714780081,4518293854155763,4518291970307083,4518291013709450,
    #     4518273368260550,4518216917077181,4518181291434749,4518172575206582,
    #     4517990085792496,4517861904022198,4517836230224958,4517813672232152,
    #     4517811630545638,4517808472483089,4517804559303358,4517575612064057,
    #     4517446968912513,4517311815936482,4517300809910428,4517202801625232,
    #     4517195429119692,4517129507156112,4517123361387185,4517118190232207,
    #     4517083834933085,4517070371089928,4516941434445201,4516839499548952,
    #     4516831484184818,4516763742389340,4516727272975482,4516725880700336,
    #     4516591746517849,4516584260117391,4516576059026479,4516574197216904,
    #     4516571827319586,4516569311065316,4516530220532023,4516515371579598,
    #     4516449533911729,4516226049908503,4516120302762076,4516107929773947,
    #     4516065423895541,4516056616266897,4516028383987112,4516017961861107,
    #     4516013691755027,4515995006758283,4515988387507756,4515862784927211,
    #     4515790327411427,4515776244379345,4515723886345564,4515703761965042,
    #     4515671986095811,4515652318004680,4515636069320941,4515457045261643,
    #     4515413087501801,4515391756073873,4515350915752219,4515317629882481,
    #     4515293312075950,4515278405297825,4515053569274327,4515026804696434,
    #     4514667445877356,4513829009101499,4513618358589361,4513244922452024,
    #     4513225352412839,4513145153026833,4513128114887815,4512389154544908,
    #     4512380719205808,4511660292855467,4511518962482914,4511414624004599,
    #     4511318298219069,4510929503341022,4510927326090903,4510896321816082,
    #
    # ]


    #SinaNews

    ##
    # idJanuary=[
    #     4466915202146454,4466909699293291,4466899335504906,4466896382167405,
    #     4466880779738243,4466867831572312,4466859472472202,4466816778738530,
    #     4466790644359372,4466717315037731,4466500741905163,4466471901852328,
    #     4466365354150000,4466205207782504,4466171841424006,4466141621626545,
    #     4466025283851932,4465817787326519,4465775257575952,4465772930212787,
    #     4465603966335362,4465455810566669,4465377176567216,4465356770519833,
    #     4465351435850389,4465313942906972,4465289796035585,4465127850139328,
    #     4465024167148242,4464989194328931,4464984257661797,4464728540025028,
    #     4464634252050907,4464587271643646,4464585946044426,4464570627988143,
    #     4464558414963502,4464556304491170,4464553150753494,4464531843602918,
    #     4464516899391378,4464408246255995,4464400503033744,4464355318143420,
    #     4464209276911450,4464161259995917,4464054049616663,4463955282215749,
    #     4463918032479983,4463831596442104,4463671026086505,4463668249096931,
    #     4463634422172818,4463542927682511,4463485356055911,4463476452298045,
    #     4463451047270085,4463445925807987,4463434068745275,4463418474206529,
    #     4463334923571564,4463316401587595,4463305844035358,4463226970098723,
    #     4463100960771788
    # ]
    ##

    # idFebruary=[
    #     4477257815316911,4477070576862365,4477042731021558,4476864959617896,
    #     4476858160911277,4476324116399357,4476118185195047,4475973401804563,
    #     4475879223197637,4475841666987833,4475796578542326,4475790366395730,
    #     4475616504534247,4475568554901432,4475474610849326,4475396903402761,
    #     4475259271493999,4475244158972297,4475220204840962,4475203122338465,
    #     4475143000451475,4475074754965570,4475053272049843,4475048695925679,
    #     4474898716428994,4474893707520142,4474881599482773,4474840465890781,
    #     4474764142294005,4474674660729748,4474668205248436,4474418937612682,
    #     4474393247714437,4474364664052630,4474358489224677,4474319935496008,
    #     4474174988696135,4474138733582994,4474005479910408,4473749992175029,
    #     4473287851356359,4473235653382597,4473078090122968,4473070796311851,
    #     4472984326396178,4472721339137765,4472697566114393,4472559087321666,
    #     4472323723298689,4472303939284070,4472219466083512,4472158116050902,
    #     4471814518843850,4471809154218274,4471632879423348,4471413056164650,
    #     4471215207084374,4471192201534864,4471175897780901,4471142616412880,
    #     4471121916838815,4471043441321879,4470698095548304,4470685054860409,
    #     4470533729517358,4470461762859858,4470334038524777,4470120417666792,
    #     4469688895972665,4469669823523921,4469654217517262,4469643055965530,
    #     4469386578557497,4469357063337779,4469226989440506,4469202931402396,
    #     4469126443109776,4469029160652346,4469010156244435,4468876785941984,
    #     4468300757108736,4467841044645779,4467830193493562,4467633925141867,
    #     4467507585126809,4467511645117657,4467498693340846,4467283852092630,
    #     4467279155105433,4467234531107881,4467172573049405,4467149592710122
    # ]
    #
    # idMarch=[
    #     4467131527999509,4488308425702684,4488085527855532,4487939645702835,
    #     4487929021771307,4487896843651122,4487763082761503,4487410282869395,
    #     4487376279255027,4487360245047606,4486471518200622,4486313523159870,
    #     4486291922065643,4486273593360455,4486053475903532,4486017593637965,
    #     4485924693487365,4485713929779439,4485681609100927,4485211758513442,
    #     4484957894836622,4484821600733143,4484501562893082,4484320712235640,
    #     4484267461579898,4484194904527490,4484117288336994,4484111970357554,
    #     4483728930040270,4483579352814952,4483577217520937,4483446140857125,
    #     4483403875540601,4483167362686758,4483162187010543,4483029265556933,
    #     4482854991887207,4482745852466621,4482686284377113,4482670212291785,
    #     4482506625365219,4482494722241868,4482298495975782,4481605177614865,
    #     4480957094514514,4480323901320066,4479965854933625,4479608055107744,
    #     4478891219761842,4478822890230236,4478762663978671,4478731676774340,
    #     4478324254755700,4478145119878109,4477991671381994,4477613567423018,
    #     4477576611519391
    # ]

    # idJune=[
    #     4520017871949076,4519803127544395,4519644188421243,4519278093966274,
    #     4519054709433229,4519001365311543,4518726294588949,4518338308980825,
    #     4518229374510885,4518184030218658,4518008464529252,4517989392703136,
    #     4517930668913404,4517475687804445,4517267801222110,4517081858946422,
    #     4516931010831379,4516782318907712,4516760760718382,4516580736602385,
    #     4516437177636247,4516417057230342,4516161373863083,4516090056859885,
    #     4516084646179987,4515994666581039,4515796136816536,4515748330029423,
    #     4515735948274941,4515692340548354,4515636875257324,4515432185286371,
    #     4515365654718463,4515353717282040,4515326601234027,4515314958162638,
    #     4512499515680986
    # ]

    # idMay=[
    #     4509532002507338,4508864630740402,4508026042265081,4507750065294435,
    #     4507312276410928,4506733206491743,4506672595353409,4506662230689781,
    #     4506560224585032,4505920397518991,4505331369449291,4504964091396672,
    #     4504422603257955,4504035938342499,4503315604255358,4502705320647677,
    #     4502577495053492,4502423190826761,4502342994648192,4500908023618109,
    #     4500418426832384,4499788140404633,4499684335475433
    # ]

    idApril=[
        4499530937383791,4499524780196015,4499450004029403,4499316137693829,
        4499113687459127,4498798132353377,4498758203145013,4497921145862396,
        4497859745707455,4497333624679903,4497160764339818,4497004795615637,
        4496976638822619,4496965079824104,4496239401435527,4496141569248598,
        4496074104729421,4495739478647577,4495724740249639,4495478546851096,
        4495142038007203,4495041379155333,4494618693370484,4494243404423943,
        4494099711328647,4494085799030144,4494049832144939,4493886855007379,
        4493881863235011,4493644503797553,4493542036979009,4493289560690454,
        4492992884897681,4492885871531924,4492622599347932,4492556345356521,
        4491845696037831,4490817211719819,4490722952869953,4490660226947351,
        4490481159511680,4490383356393206,4490351891292583,4490314427423306,
        4489932997225171,4489927771687893,4489911769559383,4489896573856107,
        4489748318179996,4489682982902514,4489555660806668,4489260360740870,
        4489164554831845,4489027731957430,4488956983373539
    ]

    for id in idApril:
        scrapy(id)
        print(str(id)+" ok")

